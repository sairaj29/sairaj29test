version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "Installing dependencies..."
      - |
        curl -I https://google.com || { echo "Network issue detected"; exit 1; }
      - yum clean all
      - yum update -y || true
      - if ! command -v docker-compose &> /dev/null; then
          echo "Installing docker-compose from source...";
          curl -L "https://github.com/docker/compose/releases/download/2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose;
          chmod +x /usr/local/bin/docker-compose;
          ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose;
        else
          echo "docker-compose is already installed.";
        fi
      - pip install bandit flake8
      - sudo systemctl start docker
      - sudo docker info

  pre_build:
    commands:
      - echo "Running Static Code Analysis..."
      - flake8 backend/app.py
      - bandit -r backend

  build:
    commands:
      - echo "Building Docker Compose services..."
      - docker-compose build | tee build.log
      - echo "Tagging Docker images for ECR..."
      - docker tag backend:latest public.ecr.aws/i4a2a9c3/sairaj29test:backend-latest
      - docker tag frontend:latest public.ecr.aws/i4a2a9c3/sairaj29test:frontend-latest
      - echo "Pushing Docker images to ECR..."
      - docker push public.ecr.aws/i4a2a9c3/sairaj29test:backend-latest | tee -a build.log
      - docker push public.ecr.aws/i4a2a9c3/sairaj29test:frontend-latest | tee -a build.log

  post_build:
    commands:
      - echo "Build and push to ECR completed successfully."

artifacts:
  files:
    - docker-compose.yml
    - backend/**/*
    - frontend/**/*
